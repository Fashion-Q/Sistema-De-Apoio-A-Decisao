-- Scripts ddl para o ambiente dimensional
/*
PAGAMENTO V
PRODUTO V
LOJA V
VENDA
AVALIACAO 
STATUS 
*/
USE hawkmart

DROP TABLE IF EXISTS FATO_VENDA
DROP TABLE IF EXISTS DIM_PRODUTO
DROP TABLE IF EXISTS DIM_LOJA
DROP TABLE IF EXISTS DIM_TEMPO
DROP TABLE IF EXISTS DIM_PAGAMENTO
DROP TABLE IF EXISTS DIM_AVALIACAO
DROP TABLE IF EXISTS DIM_STATUS

CREATE TABLE DIM_TEMPO (
	ID_TEMPO BIGINT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	NIVEL VARCHAR(8) NOT NULL CHECK (NIVEL IN ('DIA','MES','ANO')),
	DATA DATETIME NULL, 
	DIA INT NULL,
	DIA_SEMANA VARCHAR(50) NULL, 
	FIM_SEMANA VARCHAR(3) NULL CHECK (FIM_SEMANA IN ('SIM','NAO')),
	FERIADO VARCHAR(100) NULL, 
	FL_FERIADO VARCHAR(3) NULL CHECK (FL_FERIADO IN ('SIM','NAO')),
	MES INT NULL, 
	NOME_MES VARCHAR(100) NULL,
	TRIMESTRE INT NULL, 
	NOME_TRIMESTRE VARCHAR(100) NULL, 
	SEMESTRE INT NULL, 
	NOME_SEMESTRE VARCHAR(100) NULL, 
	ANO INT NOT NULL
)
CREATE INDEX IX_DIM_TEMPO_DATA ON DIM_TEMPO (DATA)
CREATE INDEX IX_DIM_TEMPO_DATA_MES ON DIM_TEMPO (NIVEL, MES)
CREATE INDEX IX_DIM_TEMPO_DATA_ANO ON DIM_TEMPO (NIVEL, ANO)


CREATE TABLE DIM_AVALIACAO(
	ID_AVALIACAO INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
	COD_AVALIACAO INT NOT NULL,
	INDEX IX_DIM_AVALIACAO (COD_AVALIACAO),
	CONSTRAINT UQ_COD_AVALIACAO UNIQUE (COD_AVALIACAO)
)

CREATE TABLE DIM_STATUS(
	ID_STATUS INT NOT NULL IDENTITY(1,1) PRIMARY KEY (ID_STATUS),
	COD_STATUS INT NOT NULL,
	STATUS VARCHAR(50) NOT NULL DEFAULT 'AGUARDANDO PAGAMENTO',
	INDEX IX_DIM_STATUS(STATUS),
	INDEX IX_DIM_COD_STATUS(COD_STATUS),
	CONSTRAINT UQ_COD_STATUS UNIQUE (COD_STATUS)
)

CREATE TABLE DIM_PRODUTO(
	ID_PRODUTO INT NOT NULL IDENTITY(1,1),
	COD_PRODUTO INT NOT NULL,
	PRODUTO VARCHAR(100) NOT NULL,
	COD_SUBCATEGORIA INT NOT NULL,
	SUBCATEGORIA VARCHAR(100) NOT NULL,
	COD_CATEGORIA INT NOT NULL,
	CATEGORIA VARCHAR(100) NOT NULL,
	PRIMARY KEY (ID_PRODUTO),
	INDEX IX_DIM_COD_PRODUTO (COD_PRODUTO),
	INDEX INDEX_SUBCATEGORIA (SUBCATEGORIA),
	INDEX INDEX_CATEGORIA (CATEGORIA),
	INDEX INDEX_PRODUTO (PRODUTO),
	CONSTRAINT UQ_COD_PRODUTO UNIQUE (COD_PRODUTO)
)

CREATE TABLE DIM_PAGAMENTO(
	ID_PAGAMENTO INT NOT NULL IDENTITY(1,1),
	COD_PAGAMENTO INT NOT NULL,
	PAGAMENTO VARCHAR(50) NOT NULL,
	PRIMARY KEY (ID_PAGAMENTO),
	INDEX IX_DIM_PAGAMENTO (COD_PAGAMENTO),
	INDEX INDEX_PAGAMENTO (PAGAMENTO),
	CONSTRAINT UQ_COD_PAGAMENTO UNIQUE (COD_PAGAMENTO),
)
-- DEBITO CREDITO PIX BOLETO
CREATE TABLE DIM_LOJA (
	ID_LOJA INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	COD_LOJA INT NOT NULL,
	LOJA VARCHAR(100) NOT NULL,
	COD_LOCALIDADE INT NOT NULL,
	CIDADE VARCHAR(100) NOT NULL,
	ESTADO VARCHAR(100) NOT NULL,
	SIGLA_ESTADO CHAR(2) NOT NULL CHECK (LEN(SIGLA_ESTADO) = 2),
	INDEX IX_DIM_COD_LOJA (COD_LOJA),
	INDEX INDEX_LOJA (LOJA),
	INDEX INDEX_CIDADE(CIDADE),
	INDEX INDEX_ESTADO(ESTADO),
	CONSTRAINT UQ_COD_LOJA UNIQUE (COD_LOJA)
)

CREATE TABLE FATO_VENDA (
	ID_VENDA INT NOT NULL IDENTITY(1,1),
	ID_TEMPO BIGINT NOT NULL,
	ID_AVALIACAO INT NOT NULL,
	ID_PAGAMENTO INT NOT NULL,
	ID_STATUS INT NOT NULL,
	ID_PRODUTO INT NOT NULL,
	ID_LOJA INT NOT NULL,
	COD_VENDA INT NOT NULL,
	VALOR DECIMAL(10,2) NOT NULL,
	DESCONTO DECIMAL(3,2) NOT NULL DEFAULT 1.00,
	ACAO VARCHAR(50) NOT NULL DEFAULT 'VENDIDO',
	QUANTIDADE INT NOT NULL DEFAULT 1,
	PRIMARY KEY (ID_VENDA),
	INDEX INDEX_COD_VENDA(COD_VENDA),
	INDEX INDEX_VALOR(VALOR),
	INDEX INDEX_ACAO(ACAO),
	
	CONSTRAINT FK_TEMPO
		FOREIGN KEY (ID_TEMPO)
		REFERENCES DIM_TEMPO (ID_TEMPO),
	CONSTRAINT FK_AVALIACAO
		FOREIGN KEY (ID_AVALIACAO)
		REFERENCES DIM_AVALIACAO (ID_AVALIACAO),
	CONSTRAINT FK_PAGAMENTO
		FOREIGN KEY (ID_PAGAMENTO)
		REFERENCES DIM_PAGAMENTO (ID_PAGAMENTO),
	CONSTRAINT FK_STATUS
		FOREIGN KEY (ID_STATUS)
		REFERENCES DIM_STATUS (ID_STATUS),
	CONSTRAINT FK_PRODUTO
		FOREIGN KEY (ID_PRODUTO)
		REFERENCES DIM_PRODUTO (ID_PRODUTO),
	CONSTRAINT FK_LOJA
		FOREIGN KEY (ID_LOJA)
		REFERENCES DIM_LOJA (ID_LOJA),
)

CREATE TABLE DIM_FERIADOS (
	ID_FERIADO INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
	DATA DATETIME NOT NULL,
	DESCRICAO VARCHAR(100) NOT NULL,
	TIPO VARCHAR(50) NOT NULL CHECK (TIPO in
	('NACIONAL','ESTADUAL')),
	CONSTRAINT UK_FERIADO UNIQUE (DATA)
)

CREATE TABLE FATO_VENDA_FERIADO (
	ID_VENDA INT NOT NULL IDENTITY(1,1),
	ID_TEMPO BIGINT NOT NULL,
	ID_PRODUTO INT NOT NULL,
	ID_LOJA INT NOT NULL,
	COD_VENDA INT NOT NULL,
	VALOR DECIMAL(10,2) NOT NULL,
	DESCONTO DECIMAL(3,2) NOT NULL DEFAULT 1.00,
	ACAO VARCHAR(50) NOT NULL DEFAULT 'VENDIDO',
	QUANTIDADE INT NOT NULL DEFAULT 1,
	PRIMARY KEY (ID_VENDA),
	INDEX INDEX_COD_VENDA(COD_VENDA),
	INDEX INDEX_VALOR(VALOR),
	INDEX INDEX_ACAO(ACAO),
	
	CONSTRAINT FK_TEMPO_FERIADO
		FOREIGN KEY (ID_TEMPO)
		REFERENCES DIM_TEMPO (ID_TEMPO),
	CONSTRAINT FK_PRODUTO_FERIADO
		FOREIGN KEY (ID_PRODUTO)
		REFERENCES DIM_PRODUTO (ID_PRODUTO),
	CONSTRAINT FK_LOJA_FERIADO
		FOREIGN KEY (ID_LOJA)
		REFERENCES DIM_LOJA (ID_LOJA),
)

CREATE TABLE TB_VIO_VENDA (
    ID_VIOLACAO INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
	DATA_CARGA DATETIME NULL,
	DATA_VENDA DATETIME NULL,
	COD_AVALIACAO INT NULL,
	COD_PAGAMENTO INT NULL,
	COD_STATUS INT NULL,
	COD_PRODUTO INT NULL,
	COD_LOJA INT NULL,
	COD_VENDA INT NULL,
	VALOR DECIMAL(10,2) NULL,
	DESCONTO DECIMAL(3,2) NULL DEFAULT 1.00,
	ACAO VARCHAR(50) NULL DEFAULT 'VENDIDO',
	DT_ERRO DATETIME NOT NULL,
    VIOLACAO VARCHAR(150) NOT NULL
) 